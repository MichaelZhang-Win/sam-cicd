# Overview
This is a demo for SAM, including 2 parts,

1. Local testing and deployment for Serverless application
2. Build a CICD pipeline for Serverless application

For what is SAM, refer to,
[https://aws.amazon.com/serverless/sam/](https://aws.amazon.com/serverless/sam/)

Below is the clarification for the files used in this demo.
```bash
.
├── README.md
├── buildspec.yml           # Define what to run in codebuild
├── deploy.sh              # Wrapper for deploying Serverless stack
├── env.config             # A file to define environment parameters
├── event.json             # The event definition file, in this case, it's the message for an API Gateway event
├── hello_world            # hello world example, generated by 'sam init', then update with your content
│   ├── __init__.py
│   ├── app.py
│   └── requirements.txt
├── output.sh              # Wrapper for looking at the output of CloudFormation, to get the entry of API Gateway
├── package.sh             # Wrapper for packing, which is to tranform the SAM template into CloudFormation template
├── packaged.yaml          # The CloudFormation templated transformed from SAM template
├── requirement.txt        # Dependencies for the demo Python App
├── template.yaml          # The SAM template
└── tests                 # A sample unit test
    └── unit
        ├── __init__.py
        └── test_handler.py
```

## Prerequisits
Install SAM CLI and prepare your credentials following below instructions,
[https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html)
Install Python3
Install Docker

## Step by step guide
```bash
git clone https://github.com/totorochina/sam-cicd
```
### SAM local deployment
Prepare and validate your environment
```bash
cd sam-cicd
sam build
```
Local trigger Lambda
```bash
sam local invoke
```
Start a local API Gateway for testing
```bash
sam local start-api
```
and validate it
```
curl http://127.0.0.1:3000/hello
```
Now you can deploy the API Gateway and Lambda stack directly through SAM, but before that, you have to transform SAM template into CloudFormation template,
```bash
bash package.sh
```
And what inside is,
```bash
#!/bin/bash

source env.config

sam validate && \
sam build && \
sam package \
    --output-template-file packaged.yaml \
    --s3-bucket $S3_BUCKET
```
After you get the CloudFormation template packaged.yaml, you can deploy the stack
```bash
bash deploy.sh
```
I made a wrapper, and this is what inside,
```bash
#!/bin/bash

source env.config # Use this to control your settings, regions, and environment(Test, Staging, Prod)

# Deploy defined stack to a region
sam deploy \
    --template-file packaged.yaml \
    --stack-name $STACK \
    --capabilities CAPABILITY_IAM \
    --region $REGION

# You may have to update ?OutputKey== to what you defined template.yaml output
aws cloudformation describe-stacks --stack-name $STACK \
    --query 'Stacks[0].Outputs[?OutputKey==`HelloWorldApi`].OutputValue' \
    --output text \
    --region $REGION
```
### Canary deployment
To setup canary deployment, update template.yaml for "DeploymentPreference"
```bash
 DeploymentPreference:
    Type:  Linear10PercentEvery1Minute
    #Type:  AllAtOnce
    Type:
      'Fn::Sub': '${DeploymentPreference}'
```
update the demo application, for showcase purpose, update verison number.
```
vi hello_world/app.py
```
change
```
"message": "hello world! v1.1",
to
"message": "hello world! v1.2",
```
Then package and deploy again,
```bash
bash package.sh
bash deploy.sh
```
The deployment take times for a Canary deployment, depending on the "DeploymentPreference" you set.
To watch for the process, get the API Gateway entry,
```bash
bash output.sh
```
Then curl and watch the result,
```
while true
do
    curl "<API_GATEWAY_ENDPOINT_URL>"
    echo
done
```
Then you can see the version number cumulatively change from v1.1 to v1.2.


### Using SAM for a CICD pipeline with Codepipeline
We can also use SAM and Codepipeline to build a CI/CD pipeline

#### Setup CodePipeline
Create New pipeline with Codepipeline,
Choose pipeline settings -> Remain defaults

#### Add Source Stage
   <u>Source provider</u> -> CodeCommit/GitHub
    <u>Repository Name</u> -> sam-cicd
    <u>Branch Name</u> -> master
    
#### Add Build Stage
   <u>Build provider</u> -> CodeBuild
    <u>Region</u> -> the same region with your stack
    <u>Create Project</u> -> Ensure checked 'Using buildspec', any Linux environment should work for this demo
    <u>Environment Variable</u> -> Define 'S3_BUCKET' & 'REGION'    

#### Add Deploy Stage
   <u>Deploy provider</u> -> AWS CloudFormation
    <u>Action Mode</u> -> Create or update a stack
    <u>Tempalte</u> -> BuildArtifact::packaged.yaml
    <u>Capabilities</u> -> CAPABILITY_IAM & CAPABILITY_AUTO_EXPAND
    <u>Role</u> -> Create a role with below policies
    
```
{
    "Statement": [
        {
            "Action": [
                "apigateway:*",
                "codedeploy:*",
                "lambda:*",
                "cloudformation:CreateChangeSet",
                "iam:GetRole",
                "iam:CreateRole",
                "iam:DeleteRole",
                "iam:PutRolePolicy",
                "iam:AttachRolePolicy",
                "iam:DeleteRolePolicy",
                "iam:DetachRolePolicy",
                "iam:PassRole",
                "s3:GetObjectVersion",
                "s3:GetBucketVersioning"
            ],
            "Resource": "*",
            "Effect": "Allow"
        }
```
After that, test run.

You may failed in CodeBuild as the default role it created for you automatically may not contain access to S3 bucket you defined to store artifacts. If that happended, attach AmazonS3FullAccess to the Role used by CodeBuild. 

## Appendix
If you need to make a multi-stage pipeline, e.g. Deploying AllAtOnce for Staging environment while using Linear deployment for Production, you can update the Deploy stage for each environment for each deployment stage with different
Parameter Overrides
```json
{'Env': 'prod', 'DeploymentPreference': 'Canary10Percent5Minutes'}
```
This is because below were defined in the template.yaml

```bash
Parameters:
  Env:
    Type: String
    Default: prod
    AllowedValues:
      - prod
      - staging
    Description: Define prod/staging by Parameters}

DeploymentPreference:
    Type: String
    Default: AllAtOnce
    AllowedValues:
      - Canary10Percent5Minutes
      - Canary10Percent10Minutes
      - Canary10Percent15Minutes
      - Canary10Percent30Minutes
      - Linear10PercentEvery1Minute
      - Linear10PercentEvery2Minute
      - Linear10PercentEvery3Minute
      - Linear10PercentEvery10Minute
      - AllAtOnce

DeploymentPreference:
        #Type:  Linear10PercentEvery1Minute
        #Type:  AllAtOnce
        Type:
          'Fn::Sub': '${DeploymentPreference}'
```

## License
This library is licensed under the MIT-0 License. See the LICENSE file.